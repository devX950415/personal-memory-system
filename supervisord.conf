[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid

[program:mongodb]
command=/usr/bin/mongod --dbpath /data/db --bind_ip_all --auth
autostart=true
autorestart=true
stderr_logfile=/var/log/supervisor/mongodb.err.log
stdout_logfile=/var/log/supervisor/mongodb.out.log
priority=1
startsecs=10

[program:mongodb-init]
command=/bin/bash -c "sleep 15 && mongosh --eval \"db.getSiblingDB('admin').createUser({user: 'admin', pwd: 'admin123', roles: [{role: 'root', db: 'admin'}]})\" || true"
autostart=true
autorestart=false
stderr_logfile=/var/log/supervisor/mongodb-init.err.log
stdout_logfile=/var/log/supervisor/mongodb-init.out.log
priority=2
startsecs=0

[program:fastapi]
command=/usr/local/bin/uvicorn api:app --host 0.0.0.0 --port 8888
directory=/app
autostart=true
autorestart=true
stderr_logfile=/var/log/supervisor/fastapi.err.log
stdout_logfile=/var/log/supervisor/fastapi.out.log
priority=3
startsecs=20
environment=MONGODB_URI="mongodb://admin:admin123@localhost:27017/",MONGODB_DATABASE="personalmem"
